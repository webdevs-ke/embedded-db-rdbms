import { Component } from '@angular/core'
import { Router, RouterLink, RouterLinkActive } from '@angular/router'
import {
  ReactiveFormsModule,
  FormBuilder,
  Validators,
  FormGroup,
} from '@angular/forms'
import { LibraryDBService } from '../db-service.service'

interface RegisterPayload {
  id: number
  name: string
  email: string
  phone: string
}

interface User {
  id: number
  name: string
  email: string
}

@Component({
  selector: 'app-auth',
  standalone: true,
  imports: [RouterLink, RouterLinkActive, ReactiveFormsModule],
  templateUrl: './auth.component.html',
  styleUrl: './auth.component.css',
})
export class AuthComponent {
  reg_error = ''
  log_error = ''
  user: User | null = null

  readonly registerForm: FormGroup
  readonly loginForm: FormGroup

  constructor(
    private fb: FormBuilder,
    private db: LibraryDBService,
    private router: Router
  ) {
    this.registerForm = this.fb.nonNullable.group({
      name: ['', [Validators.required, Validators.minLength(5)]],
      email: ['', [Validators.required, Validators.email]],
      phone: ['', [Validators.required, Validators.minLength(10)]],
    })

    this.loginForm = this.fb.nonNullable.group({
      email: ['', [Validators.required, Validators.email]],
      phone: ['', [Validators.required, Validators.minLength(10)]],
    })
  }

  async onRegister() {
    if (this.registerForm.invalid) return

    const payload: RegisterPayload = {
      id: Date.now(), // or generated by DB
      ...this.registerForm.getRawValue(),
    }

    try {
      await this.db.registerUser(payload)
      this.registerForm.reset()
      alert('Register success!')
    } catch (e: any) {
      this.reg_error = e.message ?? 'Registration failed'
    }
  }

  async onLogin() {
    if (this.loginForm.invalid) return

    const { email, phone } = this.loginForm.getRawValue()

    try {
      this.user = await this.db.login(email, phone)
      this.log_error = ''

      console.log('User:', this.user)
      await this.router.navigate(['/books'])

    } catch (e: any) {
      this.log_error = e.message ?? 'Login failed'
    }
  }
}